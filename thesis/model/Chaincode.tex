\batchmode %% Suppresses most terminal output.
\documentclass[../main.tex]{subfiles}

\begin{document}
% \linenumbers[1]
\tlatex
\@x{ InitializeJudgment ( package ,\, owner ,\, targetVotes ) \.{\defeq}}%
\@x{\@s{16.4}}%
\@y{\@s{0}%
    Guards
}%
\@xx{}%
\@x{\@s{16.4} \.{\land} Cost ( targetVotes ) \.{\leq} public . nodes [ owner
    ] . wallet}%
\@x{\@s{16.4} \.{\land} \A\, j \.{\in} ActiveJudgments \.{:} j . owner
\.{\neq} owner}%
\@x{\@s{16.4}}%
\@y{\@s{0}%
    Update
}%
\@xx{}%
\@x{\@s{16.4}}%
\@y{\@s{0}%
    \ensuremath{TODO}: Better ids. Currently there can only be one judgment per
    package.
}%
\@xx{}%
\@x{\@s{16.4} \.{\land} \.{\LET} judgmentId \.{\defeq} package}%
\@x{\@s{47.91} judgment \.{\defeq} [ id \.{\mapsto} judgmentId ,\,}%
\@x{\@s{110.39} tally \.{\mapsto} [ for \.{\mapsto} 0 ,\, against \.{\mapsto}
0 ] ,\,}%
\@x{\@s{110.39} finalResult \.{\mapsto}\@w{undecided} ,\,}%
\@x{\@s{110.39} package \.{\mapsto} package ,\,}%
\@x{\@s{110.39} owner \.{\mapsto} owner ,\,}%
\@x{\@s{110.39} targetVotes \.{\mapsto} targetVotes ,\,}%
\@x{\@s{110.39} status \.{\mapsto}\@w{active} ,\,}%
\@x{\@s{110.39} phase \.{\mapsto}\@w{secretVotes} ,\,}%
\@x{\@s{110.39} secretJudgments \.{\mapsto} {\langle} {\rangle} ,\,}%
\@x{\@s{110.39} openJudgments \.{\mapsto} {\langle} {\rangle} ] \.{\IN}}%
\@x{\@s{31.61} public \.{'} \.{=} [ public {\EXCEPT} {\bang} . judgments
\.{=} Append ( @ ,\, judgment ) ]}%
\@pvspace{8.0pt}%
\@x{ AddSecretJudgment ( judgmentId ,\, judge ,\, secretVote ) \.{\defeq}}%
\@x{\@s{16.4} \.{\lor}\@s{4.1} Len ( public . judgments ) \.{=} 0}%
\@x{\@s{16.4} \.{\lor}\@s{4.09} \E\, index \.{\in} {\DOMAIN} public .
judgments \.{:}}%
\@x{\@s{42.93} \.{\LET} j \.{\defeq} public . judgments [ index ] \.{\IN}}%
\@x{\@s{63.33} \.{\land} j . id \.{=} judgmentId}%
\@x{\@s{63.33} \.{\land} j . status \.{=}\@w{active}}%
\@x{\@s{63.33} \.{\land} j . phase \.{=}\@w{secretVotes}}%
\@x{\@s{63.33}}%
\@y{\@s{0}%
Has \mbox{'}judge\mbox{'} added their vote before\.{?}
}%
\@xx{}%
\@x{\@s{63.33} \.{\land} \{ sj \.{\in} Range ( j . secretJudgments ) \.{:} sj
. judge \.{=} judge \} \.{=} \{ \}}%
\@x{\@s{63.33}}%
\@y{\@s{0}%
    Update
}%
\@xx{}%
\@x{\@s{63.33} \.{\land}\@s{4.1} public \.{'} \.{=}}%
\@x{\@s{94.94} [ public {\EXCEPT} {\bang} . judgments [ index ] .
secretJudgments \.{=}}%
\@x{\@s{110.02} Append ( @ ,\, [ judge \.{\mapsto} judge ,\,}%
\@x{\@s{164.08} vote \.{\mapsto} secretVote ] ) ]}%
\@pvspace{8.0pt}%
\@x{ EndSecretSubmissions ( judgmentId ,\, owner ) \.{\defeq}}%
\@x{\@s{16.4} \.{\lor} Len ( public . judgments ) \.{=} 0}%
\@x{\@s{16.4} \.{\lor} \E\, index \.{\in} {\DOMAIN} public . judgments \.{:}}%
\@x{\@s{31.61} \.{\LET} j \.{\defeq} public . judgments [ index ] \.{\IN}}%
\@x{\@s{52.01} \.{\land} j . id \.{=} judgmentId}%
\@x{\@s{52.01} \.{\land} j . status \.{=}\@w{active}}%
\@x{\@s{52.01} \.{\land} j . phase\@s{2.49} \.{=}\@w{secretVotes}}%
\@x{\@s{52.01} \.{\land} j . owner \.{=} owner}%
\@x{\@s{52.01} \.{\land} 2 \.{*} j . targetVotes \.{-} 1 \.{\leq} Len ( j .
secretJudgments )}%
\@x{\@s{52.01} \.{\land} public \.{'} \.{=} [ public {\EXCEPT} {\bang} .
judgments [ index ] . phase}%
\@x{\@s{116.10} \.{=}\@w{openVotes} ]}%
\@pvspace{8.0pt}%
\@x{ ShowJudgment ( judgmentId ,\, judge ,\, openVote ) \.{\defeq}}%
\@x{\@s{16.4} \.{\lor} Len ( public . judgments ) \.{=} 0}%
\@x{\@s{16.4} \.{\lor} \E\, index \.{\in} {\DOMAIN} public . judgments \.{:}}%
\@x{\@s{31.61} \.{\LET} j \.{\defeq} public . judgments [ index ] \.{\IN}}%
\@x{\@s{52.01} \.{\land} j . id \.{=} judgmentId}%
\@x{\@s{52.01} \.{\land} j . status \.{=}\@w{active}}%
\@x{\@s{52.01} \.{\land} j . phase \.{=}\@w{openVotes}}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
Has \mbox{'}judge\mbox{'} added their vote before\.{?}
}%
\@xx{}%
\@x{\@s{52.01} \.{\land} \{ sj \.{\in} Range ( j . secretJudgments ) \.{:} sj
. judge \.{=} judge \} \.{\neq} \{ \}}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
Has \mbox{'}judge\mbox{'} showed their vote before\.{?}
}%
\@xx{}%
\@x{\@s{52.01} \.{\land} \{ oj \.{\in} Range ( j . openJudgments ) \.{:} oj .
judge \.{=} judge \} \.{=} \{ \}}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
    Secret and open votes should be the same
}%
\@xx{}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
    This validation is done with \ensuremath{HMAC} in practice
}%
\@xx{}%
\@x{\@s{52.01} \.{\land} \E\, sj \.{\in} Range ( j . secretJudgments ) \.{:}}%
\@x{\@s{67.22} \.{\land}\@s{4.1} sj . judge\@s{5.50} \.{=} judge}%
\@x{\@s{67.22} \.{\land}\@s{4.09} openVote \.{=} sj . vote}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
    Update
}%
\@xx{}%
\@x{\@s{52.01} \.{\land}\@s{4.1} public \.{'} \.{=} [ public {\EXCEPT}
    {\bang} . judgments [ index ] \.{=} [ @ {\EXCEPT}}%
\@x{\@s{116.10} {\bang} . openJudgments \.{=} Append ( @ ,\,}%
\@x{\@s{131.65} [\@s{8.2} judge \.{\mapsto} judge ,\,}%
\@x{\@s{142.62} vote \.{\mapsto} openVote ] ) ,\,}%
\@x{\@s{116.10} {\bang} . tally . for \.{=} {\IF} openVote \.{=}\@w{TRUE}}%
\@x{\@s{181.02} \.{\THEN} @ \.{+} 1}%
\@x{\@s{181.02} \.{\ELSE} @ ,\,}%
\@x{\@s{116.10} {\bang} . tally . against \.{=} {\IF} openVote
\.{=}\@w{FALSE}}%
\@x{\@s{177.89} \.{\THEN} @ \.{+} 1}%
\@x{\@s{177.89} \.{\ELSE} @ ] ]}%
\@pvspace{16.0pt}%
\@x{ CloseJudgment ( judgmentId ,\, owner ) \.{\defeq}}%
\@x{\@s{16.4} \.{\lor}\@s{4.1} Len ( public . judgments ) \.{=} 0}%
\@x{\@s{16.4} \.{\lor}\@s{4.09} \E\, index \.{\in} {\DOMAIN} public .
judgments \.{:}}%
\@x{\@s{42.93} \.{\LET} j \.{\defeq} public . judgments [ index ]}%
\@x{\@s{63.33} finalResult \.{\defeq} ToString ( j . tally . for \.{>} j .
tally . against ) \.{\IN}}%
\@x{\@s{63.33} \.{\land}\@s{4.1} j . id \.{=} judgmentId}%
\@x{\@s{63.33} \.{\land}\@s{4.09} j . status \.{=}\@w{active}}%
\@x{\@s{63.33} \.{\land}\@s{4.09} j . phase\@s{2.49} \.{=}\@w{openVotes}}%
\@x{\@s{63.33} \.{\land}\@s{4.09} j . owner \.{=} owner}%
\@x{\@s{63.33} \.{\land} 2 \.{*} j . targetVotes \.{-} 1 \.{\leq} Len ( j .
openJudgments )}%
\@x{\@s{78.54}}%
\@y{\@s{0}%
    We have a majority!
}%
\@xx{}%
\@x{\@s{63.33} \.{\land}\@s{4.09} \.{\lor}\@s{4.1} \.{\land}\@s{4.1} j .
tally . for \.{\neq} j . tally . against}%
\@x{\@s{93.75} \.{\land}\@s{4.09} public \.{'} \.{=} [ public {\EXCEPT}}%
\@x{\@s{125.36} {\bang} . judgments [ index ] \.{=}}%
\@x{\@s{140.91} [ @ {\EXCEPT}}%
\@x{\@s{155.56} {\bang} . status \.{=}\@w{closed} ,\,}%
\@x{\@s{155.56} {\bang} . phase \.{=}\@w{judgment} ,\,}%
\@x{\@s{155.56} {\bang} . finalResult \.{=} finalResult ] ,\,}%
\@x{\@s{125.36} {\bang} . nodes \.{=} Rewards ( j ) ]}%
\@x{\@s{78.54}}%
\@y{\@s{0}%
    Everyone has voted, and we don\mbox{'}t have a majority
}%
\@xx{}%
\@x{\@s{78.54} \.{\lor}\@s{4.1} \.{\land}\@s{4.1} j . tally . for \.{=} j .
tally . against}%
\@x{\@s{93.75} \.{\land}\@s{4.09} public \.{'} \.{=} [ public {\EXCEPT}
    {\bang} . judgments [ index ] \.{=} [ @ {\EXCEPT}}%
\@x{\@s{157.84} {\bang} . status \.{=}\@w{closed} ,\,}%
\@x{\@s{157.84} {\bang} . finalResult \.{=}\@w{undecided} ] ]}%
\end{document}