\batchmode %% Suppresses most terminal output.
\documentclass[../main.tex]{subfiles}

\begin{document}
% \linenumbers[1]
\tlatex
\@x{}\moduleLeftDash\@xx{ {\MODULE} Judgment}\moduleRightDash\@xx{}%
\@x{ {\EXTENDS} TLC ,\, FiniteSets ,\, Reals ,\, Sequences}%
\@pvspace{8.0pt}%
\@x{ {\VARIABLE} public ,\, private ,\, nextPackageId}%
\@pvspace{8.0pt}%
\@x{ {\CONSTANT} NumberOfClosedJudgmentsGoal}%
\@pvspace{16.0pt}%
 \@x{ Nodes \.{\defeq} \{\@w{node1} ,\,\@w{node2} ,\,\@w{node3} ,\,\@w{node4}
 \}}%
\@x{ MaliciousNodes \.{\defeq} \{\@w{node4} \}}%
\@pvspace{8.0pt}%
\@x{ InitialPrivate\@s{9.53} \.{\defeq} private \.{=} [}%
\@x{\@s{16.4} node1 \.{\mapsto} [}%
\@x{\@s{32.8} preferences \.{\mapsto} {\langle}}%
 \@x{\@s{49.19} [ package \.{\mapsto}\@w{package1} ,\, level \.{\mapsto} 2 ,\,
 status \.{\mapsto}\@w{not{-}processed} ] ,\,}%
 \@x{\@s{49.19} [ package \.{\mapsto}\@w{package2} ,\, level \.{\mapsto} 2 ,\,
 status \.{\mapsto}\@w{not{-}processed} ]}%
\@x{\@s{32.8} {\rangle}}%
\@x{\@s{16.4} ] ,\,}%
\@x{\@s{16.4} node2 \.{\mapsto} [}%
\@x{\@s{32.8} preferences \.{\mapsto} {\langle}}%
 \@x{\@s{49.19} [ package \.{\mapsto}\@w{package3} ,\, level \.{\mapsto} 2 ,\,
 status \.{\mapsto}\@w{not{-}processed} ] ,\,}%
 \@x{\@s{49.19} [ package \.{\mapsto}\@w{package4} ,\, level \.{\mapsto} 2 ,\,
 status \.{\mapsto}\@w{not{-}processed} ]}%
\@x{\@s{32.8} {\rangle}}%
\@x{\@s{16.4} ] ,\,}%
\@x{\@s{16.4} node3 \.{\mapsto} [}%
\@x{\@s{32.8} preferences \.{\mapsto} {\langle}}%
 \@x{\@s{49.19} [ package \.{\mapsto}\@w{package5} ,\, level \.{\mapsto} 2 ,\,
 status \.{\mapsto}\@w{not{-}processed} ] ,\,}%
 \@x{\@s{49.19} [ package \.{\mapsto}\@w{package6} ,\, level \.{\mapsto} 2 ,\,
 status \.{\mapsto}\@w{not{-}processed} ]}%
\@pvspace{8.0pt}%
\@x{\@s{32.8} {\rangle}}%
\@x{\@s{16.4} ] ,\,}%
\@x{\@s{16.4} node4 \.{\mapsto} [}%
\@x{\@s{32.8} preferences \.{\mapsto} {\langle}}%
 \@x{\@s{49.19} [ package \.{\mapsto}\@w{package7} ,\, level \.{\mapsto} 2 ,\,
 status \.{\mapsto}\@w{not{-}processed} ] ,\,}%
 \@x{\@s{49.19} [ package \.{\mapsto}\@w{package8} ,\, level \.{\mapsto} 2 ,\,
 status \.{\mapsto}\@w{not{-}processed} ]}%
\@pvspace{8.0pt}%
\@x{\@s{32.8} {\rangle}}%
\@x{\@s{16.4} ]}%
\@x{ ]}%
\@pvspace{8.0pt}%
\@x{ InitialPublic \.{\defeq} public \.{=} [}%
\@x{\@s{16.4} nodes \.{\mapsto} [}%
\@x{\@s{32.8} node1 \.{\mapsto} [ wallet \.{\mapsto} 3 ] ,\,}%
\@x{\@s{32.8} node2 \.{\mapsto} [ wallet \.{\mapsto} 0 ] ,\,}%
\@x{\@s{32.8} node3 \.{\mapsto} [ wallet \.{\mapsto} 0 ] ,\,}%
\@x{\@s{32.8} node4 \.{\mapsto} [ wallet \.{\mapsto} 0 ]}%
\@x{\@s{16.4} ] ,\,}%
\@x{\@s{16.4} judgments \.{\mapsto} {\langle} {\rangle}}%
\@x{ ]}%
\@pvspace{8.0pt}%
 \@x{ IsReproducibleData \.{\defeq}\@s{8.2} [ package1 \.{\mapsto} {\TRUE}
 ,\,}%
\@x{\@s{114.37} package2 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package3 \.{\mapsto} {\TRUE} ,\,}%
\@x{\@s{114.37} package4 \.{\mapsto} {\TRUE} ,\,}%
\@x{\@s{114.37} package5 \.{\mapsto} {\TRUE} ,\,}%
\@x{\@s{114.37} package6 \.{\mapsto} {\TRUE} ,\,}%
\@x{\@s{114.37} package7 \.{\mapsto} {\TRUE} ,\,}%
\@x{\@s{114.37} package8 \.{\mapsto} {\TRUE} ,\,}%
\@x{\@s{114.37} package9 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package10 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package11 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package12 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package13 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package14 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package15 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package16 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package17 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package18 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package19 \.{\mapsto} {\FALSE} ,\,}%
\@x{\@s{114.37} package20 \.{\mapsto} {\FALSE} ]}%
\@pvspace{8.0pt}%
\@x{ Range ( f ) \.{\defeq} \{ f [ k ] \.{:} k \.{\in} {\DOMAIN} f \}}%
\@pvspace{8.0pt}%
 \@x{ KeyValues ( m ) \.{\defeq} \{ {\langle} k ,\, m [ k ] {\rangle} \.{:} k
 \.{\in} {\DOMAIN} m \}}%
\@pvspace{8.0pt}%
\@x{}%
\@y{\@s{0}%
 Source: https:\ensuremath{\.{\slsl}learntla.com}/libraries/sets/
}%
\@xx{}%
\@x{ Pick ( S ) \.{\defeq} {\CHOOSE} s \.{\in} S \.{:} {\TRUE}}%
\@x{ {\RECURSIVE} SetReduce ( \_ ,\, \_ ,\, \_ )}%
 \@x{ SetReduce ( Op ( \_ ,\, \_ ) ,\, S ,\, value ) \.{\defeq} {\IF} S \.{=}
 \{ \} \.{\THEN} value}%
\@x{\@s{130.43} \.{\ELSE} \.{\LET} s \.{\defeq} Pick ( S )}%
 \@x{\@s{130.43} \.{\IN} SetReduce ( Op ,\, S \.{\,\backslash\,} \{ s \} ,\,
 Op ( s ,\, value ) )}%
\@pvspace{8.0pt}%
\@x{ Sum ( S ) \.{\defeq}}%
\@x{\@s{23.82} \.{\LET} \_op ( a ,\, b ) \.{\defeq} a \.{+} b}%
\@x{\@s{23.82} \.{\IN} SetReduce ( \_op ,\, S ,\, 0 )}%
\@pvspace{8.0pt}%
\@x{ IsReproducible ( p ) \.{\defeq} IsReproducibleData [ p ]}%
\@pvspace{8.0pt}%
\@x{ {\RECURSIVE} Cost ( \_ )}%
 \@x{ Cost ( level ) \.{\defeq} {\IF} level \.{=} 0 \.{\THEN} 0 \.{\ELSE}
 level \.{+} Cost ( level \.{-} 1 )}%
\@pvspace{8.0pt}%
\@x{ {\RECURSIVE} LevelHelp ( \_ ,\, \_ )}%
\@x{ LevelHelp ( available ,\, stepCost ) \.{\defeq}}%
\@x{\@s{16.4} {\IF} stepCost \.{>} available}%
\@x{\@s{32.65} \.{\THEN} 0}%
 \@x{\@s{32.65} \.{\ELSE} 1 \.{+} LevelHelp ( available \.{-} stepCost ,\,
 stepCost \.{+} 1 )}%
\@pvspace{8.0pt}%
\@x{ Level ( cost ) \.{\defeq} LevelHelp ( cost ,\, 1 )}%
\@pvspace{8.0pt}%
\@x{ {\RECURSIVE} WalletUpdatesForVoters ( \_ ,\, \_ ,\, \_ ,\, \_ )}%
 \@x{ WalletUpdatesForVoters ( judgment ,\, votes ,\, reward ,\, updates )
 \.{\defeq}}%
 \@x{\@s{16.4} \.{\LET} finalResult \.{\defeq} ToString ( judgment . tally .
 for \.{>} judgment . tally . against )}%
\@x{\@s{36.79} judge \.{\defeq} Head ( votes ) . judge}%
\@x{\@s{36.79} vote \.{\defeq} Head ( votes ) . vote}%
\@x{\@s{16.4} \.{\IN}}%
\@x{\@s{32.8} {\IF} Len ( votes ) \.{=} 0}%
\@x{\@s{49.05} \.{\THEN} updates}%
\@x{\@s{32.8} \.{\ELSE} {\IF} judge \.{=} judgment . owner}%
\@x{\@s{49.19}}%
\@y{\@s{0}%
 Skip the owner
}%
\@xx{}%
\@x{\@s{49.19} \.{\THEN} WalletUpdatesForVoters (}%
\@x{\@s{65.6} judgment ,\, Tail ( votes ) ,\, reward ,\, updates )}%
\@x{\@s{32.8} \.{\ELSE} {\IF} vote \.{\neq} finalResult \.{\THEN} \.{\LET}}%
\@x{\@s{49.19}}%
\@y{\@s{0}%
 Minority voter
}%
\@xx{}%
 \@x{\@s{65.6} newUpdates \.{\defeq} [ updates {\EXCEPT} {\bang} [ judge ] .
 wallet \.{=} @ ]}%
\@x{\@s{49.19} \.{\IN} WalletUpdatesForVoters (}%
\@x{\@s{73.69} judgment ,\, Tail ( votes ) ,\, reward ,\, newUpdates )}%
\@x{\@s{32.8} \.{\ELSE} \.{\LET}}%
\@x{\@s{49.19}}%
\@y{\@s{0}%
 Majority voter
}%
\@xx{}%
 \@x{\@s{65.6} newUpdates \.{\defeq} [ updates {\EXCEPT} {\bang} [ judge ] .
 wallet \.{=} @ \.{+} reward \.{+} 1 ]}%
 \@x{\@s{73.69} newReward \.{\defeq} {\IF} reward \.{=} 0 \.{\THEN} 0
 \.{\ELSE} reward \.{-} 1}%
\@x{\@s{53.29} \.{\IN} WalletUpdatesForVoters (}%
\@x{\@s{90.09} judgment ,\, Tail ( votes ) ,\, newReward ,\, newUpdates )}%
\@pvspace{8.0pt}%
\@x{ {\RECURSIVE} WalletUpdatesForNotVoting ( \_ ,\, \_ )}%
\@x{ WalletUpdatesForNotVoting ( nonVoters ,\, updates ) \.{\defeq}}%
\@x{\@s{16.4} {\IF} nonVoters \.{=} \{ \}}%
\@x{\@s{32.65} \.{\THEN} updates}%
\@x{\@s{32.65} \.{\ELSE}}%
 \@x{\@s{49.05} \.{\LET} v \.{\defeq} {\CHOOSE} voter \.{\in} nonVoters \.{:}
 {\TRUE}}%
 \@x{\@s{73.55} newUpdates \.{\defeq} [ updates {\EXCEPT} {\bang} [ v ] .
 wallet \.{=} @ \.{-} 1 ]}%
 \@x{\@s{49.05} \.{\IN}\@s{4.09} WalletUpdatesForNotVoting ( nonVoters
 \.{\,\backslash\,} \{ v \} ,\, newUpdates )}%
\@pvspace{16.0pt}%
\@x{ FutureCost ( node ) \.{\defeq}}%
\@x{\@s{16.4} \.{\LET} NotProcessedYet \.{\defeq}}%
 \@x{\@s{53.19} \{ p \.{\in} Range ( private [ node ] . preferences ) \.{:} p
 . status \.{\neq}\@w{processed} \}}%
 \@x{\@s{16.4} \.{\IN} Sum ( \{ Cost ( p . level ) \.{:} p \.{\in}
 NotProcessedYet \} )}%
\@pvspace{16.0pt}%
\@x{ AllPreferences \.{\defeq}}%
\@x{\@s{16.4} \.{\LET} op ( a ,\, b ) \.{\defeq} a \.{\circ} b}%
 \@x{\@s{16.4} \.{\IN} SetReduce ( op ,\, \{ p . preferences \.{:} p \.{\in}
 Range ( private ) \} ,\, {\langle} {\rangle} )}%
\@pvspace{8.0pt}%
\@x{ Min ( S ) \.{\defeq}}%
\@x{\@s{22.31} {\CHOOSE} e \.{\in} S \.{\cup} \{ 0 \} \.{:}}%
\@x{\@s{38.71} \A\, e2 \.{\in} S \.{:} e \.{\leq} e2}%
\@pvspace{8.0pt}%
\@x{ SecretJudges ( judgment ) \.{\defeq}}%
 \@x{\@s{16.4} \{ j . judge \.{:} j \.{\in} Range ( judgment . secretJudgments
 ) \}}%
\@pvspace{8.0pt}%
\@x{ OpenJudges ( judgment ) \.{\defeq}}%
 \@x{\@s{16.4} \{ j . judge \.{:} j \.{\in} Range ( judgment . openJudgments )
 \}}%
\@pvspace{8.0pt}%
\@x{ Rewards ( judgment ) \.{\defeq}}%
 \@x{\@s{16.4} \.{\LET} openVotes\@s{4.11} \.{\defeq} judgment .
 openJudgments}%
\@x{\@s{36.79} topReward\@s{2.12} \.{\defeq} judgment . targetVotes}%
\@x{\@s{36.79} wallets \.{\defeq} public . nodes}%
\@x{\@s{36.79} openVoters \.{\defeq} OpenJudges ( judgment )}%
 \@x{\@s{36.79} nonVoters\@s{1.63} \.{\defeq} Nodes \.{\,\backslash\,}
 openVoters}%
\@x{\@s{36.79} ownerCost \.{\defeq} Cost ( judgment . targetVotes )}%
\@x{\@s{36.79} updatesForVoters \.{\defeq}}%
 \@x{\@s{53.19} WalletUpdatesForVoters ( judgment ,\, openVotes ,\, topReward
 ,\, wallets )}%
\@x{\@s{40.89} updatesForNonVoters \.{\defeq}}%
\@x{\@s{57.29} WalletUpdatesForNotVoting ( nonVoters ,\, updatesForVoters )}%
 \@x{\@s{16.4} \.{\IN}\@s{4.09} [ updatesForNonVoters {\EXCEPT} {\bang} [
 judgment . owner ] . wallet \.{=} @ \.{-} ownerCost ]}%
\@pvspace{24.0pt}%
\@x{ AddPreferencedPackage ( node ) \.{\defeq}}%
 \@x{\@s{16.4} \.{\LET} currentBalance \.{\defeq} public . nodes [ node ] .
 wallet}%
\@x{\@s{36.79} pendingPackagesCount \.{\defeq} Level ( FutureCost ( node ) )}%
 \@x{\@s{36.79} maxJudgmentCost \.{\defeq} currentBalance \.{-} FutureCost (
 node )}%
\@x{\@s{36.79} maxJudgmentLevel \.{\defeq} Level ( maxJudgmentCost )}%
\@x{\@s{36.79} packageLevel \.{\defeq} maxJudgmentLevel}%
 \@x{\@s{36.79} packageName \.{\defeq}\@w{package} \.{\circ} ToString (
 nextPackageId )}%
\@x{\@s{36.79} package \.{\defeq} [ package \.{\mapsto} packageName ,\,}%
\@x{\@s{92.43} level \.{\mapsto} packageLevel ,\,}%
\@x{\@s{92.43} status \.{\mapsto}\@w{not{-}processed} ]}%
\@x{\@s{16.4} \.{\IN}}%
\@x{\@s{32.8} \.{\land} packageLevel \.{>} 1}%
\@x{\@s{32.8} \.{\land} pendingPackagesCount \.{<} 2}%
 \@x{\@s{32.8} \.{\land} private \.{'} \.{=} [ private {\EXCEPT} {\bang} [
 node ] . preferences}%
\@x{\@s{52.11} \.{=} Append ( @ ,\, package ) ]}%
\@x{\@s{32.8} \.{\land} nextPackageId \.{'} \.{=} nextPackageId \.{+} 1}%
\@pvspace{8.0pt}%
\@x{ ActiveJudgments \.{\defeq}}%
 \@x{\@s{16.4} \{ j \.{\in} Range ( public . judgments ) \.{:} j . status
 \.{=}\@w{active} \}}%
\@pvspace{8.0pt}%
\@x{ ClosedJudgments \.{\defeq}}%
 \@x{\@s{16.4} \{ j \.{\in} Range ( public . judgments ) \.{:} j . status
 \.{=}\@w{closed} \}}%
\@pvspace{8.0pt}%
\@x{ RunSimulation \.{\defeq}}%
 \@x{\@s{16.4} Cardinality ( ClosedJudgments ) \.{<}
 NumberOfClosedJudgmentsGoal}%
\@pvspace{8.0pt}%
\@x{ IsFinanciallyIncentivizedToVote ( node ) \.{\defeq}}%
 \@x{\@s{16.4} FutureCost ( node ) \.{\leq} public . nodes [ node ] . wallet
 \.{-} 1}%
\@pvspace{8.0pt}%
\@x{ PreferredPackages ( node ) \.{\defeq}}%
 \@x{\@s{16.4} \{ p . package \.{:} p \.{\in} Range ( private [ node ] .
 preferences ) \}}%
\@pvspace{8.0pt}%
\@x{}%
\@y{\@s{0}%
 \ceqdash{8} \ensuremath{Chaincode} \ceqdash{8}
}%
\@xx{}%
\@pvspace{8.0pt}%
\@x{ InitializeJudgment ( package ,\, owner ,\, targetVotes ) \.{\defeq}}%
\@x{\@s{16.4}}%
\@y{\@s{0}%
 Guards
}%
\@xx{}%
 \@x{\@s{16.4} \.{\land} Cost ( targetVotes ) \.{\leq} public . nodes [ owner
 ] . wallet}%
 \@x{\@s{16.4} \.{\land} \A\, j \.{\in} ActiveJudgments \.{:} j . owner
 \.{\neq} owner}%
\@x{\@s{16.4}}%
\@y{\@s{0}%
 Update
}%
\@xx{}%
\@x{\@s{16.4}}%
\@y{\@s{0}%
 \ensuremath{TODO}: Better ids. Currently there can only be one judgment per
 package.
}%
\@xx{}%
\@x{\@s{16.4} \.{\land} \.{\LET} judgmentId \.{\defeq} package}%
\@x{\@s{47.91} judgment \.{\defeq} [ id \.{\mapsto} judgmentId ,\,}%
 \@x{\@s{110.39} tally \.{\mapsto} [ for \.{\mapsto} 0 ,\, against \.{\mapsto}
 0 ] ,\,}%
\@x{\@s{110.39} finalResult \.{\mapsto}\@w{undecided} ,\,}%
\@x{\@s{110.39} package \.{\mapsto} package ,\,}%
\@x{\@s{110.39} owner \.{\mapsto} owner ,\,}%
\@x{\@s{110.39} targetVotes \.{\mapsto} targetVotes ,\,}%
\@x{\@s{110.39} status \.{\mapsto}\@w{active} ,\,}%
\@x{\@s{110.39} phase \.{\mapsto}\@w{secretVotes} ,\,}%
\@x{\@s{110.39} secretJudgments \.{\mapsto} {\langle} {\rangle} ,\,}%
\@x{\@s{110.39} openJudgments \.{\mapsto} {\langle} {\rangle} ] \.{\IN}}%
 \@x{\@s{31.61} public \.{'} \.{=} [ public {\EXCEPT} {\bang} . judgments
 \.{=} Append ( @ ,\, judgment ) ]}%
\@pvspace{8.0pt}%
\@x{ AddSecretJudgment ( judgmentId ,\, judge ,\, secretVote ) \.{\defeq}}%
\@x{\@s{16.4} \.{\lor}\@s{4.1} Len ( public . judgments ) \.{=} 0}%
 \@x{\@s{16.4} \.{\lor}\@s{4.09} \E\, index \.{\in} {\DOMAIN} public .
 judgments \.{:}}%
\@x{\@s{42.93} \.{\LET} j \.{\defeq} public . judgments [ index ] \.{\IN}}%
\@x{\@s{63.33} \.{\land} j . id \.{=} judgmentId}%
\@x{\@s{63.33} \.{\land} j . status \.{=}\@w{active}}%
\@x{\@s{63.33} \.{\land} j . phase \.{=}\@w{secretVotes}}%
\@x{\@s{63.33}}%
\@y{\@s{0}%
 Has \mbox{'}judge\mbox{'} added their vote before\.{?}
}%
\@xx{}%
 \@x{\@s{63.33} \.{\land} \{ sj \.{\in} Range ( j . secretJudgments ) \.{:} sj
 . judge \.{=} judge \} \.{=} \{ \}}%
\@x{\@s{63.33}}%
\@y{\@s{0}%
 Update
}%
\@xx{}%
\@x{\@s{63.33} \.{\land}\@s{4.1} public \.{'} \.{=}}%
 \@x{\@s{94.94} [ public {\EXCEPT} {\bang} . judgments [ index ] .
 secretJudgments \.{=}}%
\@x{\@s{110.02} Append ( @ ,\, [ judge \.{\mapsto} judge ,\,}%
\@x{\@s{164.08} vote \.{\mapsto} secretVote ] ) ]}%
\@pvspace{8.0pt}%
\@x{ EndSecretSubmissions ( judgmentId ,\, owner ) \.{\defeq}}%
\@x{\@s{16.4} \.{\lor} Len ( public . judgments ) \.{=} 0}%
\@x{\@s{16.4} \.{\lor} \E\, index \.{\in} {\DOMAIN} public . judgments \.{:}}%
\@x{\@s{31.61} \.{\LET} j \.{\defeq} public . judgments [ index ] \.{\IN}}%
\@x{\@s{52.01} \.{\land} j . id \.{=} judgmentId}%
\@x{\@s{52.01} \.{\land} j . status \.{=}\@w{active}}%
\@x{\@s{52.01} \.{\land} j . phase\@s{2.49} \.{=}\@w{secretVotes}}%
\@x{\@s{52.01} \.{\land} j . owner \.{=} owner}%
 \@x{\@s{52.01} \.{\land} 2 \.{*} j . targetVotes \.{-} 1 \.{\leq} Len ( j .
 secretJudgments )}%
 \@x{\@s{52.01} \.{\land} public \.{'} \.{=} [ public {\EXCEPT} {\bang} .
 judgments [ index ] . phase}%
\@x{\@s{116.10} \.{=}\@w{openVotes} ]}%
\@pvspace{8.0pt}%
\@x{ ShowJudgment ( judgmentId ,\, judge ,\, openVote ) \.{\defeq}}%
\@x{\@s{16.4} \.{\lor} Len ( public . judgments ) \.{=} 0}%
\@x{\@s{16.4} \.{\lor} \E\, index \.{\in} {\DOMAIN} public . judgments \.{:}}%
\@x{\@s{31.61} \.{\LET} j \.{\defeq} public . judgments [ index ] \.{\IN}}%
\@x{\@s{52.01} \.{\land} j . id \.{=} judgmentId}%
\@x{\@s{52.01} \.{\land} j . status \.{=}\@w{active}}%
\@x{\@s{52.01} \.{\land} j . phase \.{=}\@w{openVotes}}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
 Has \mbox{'}judge\mbox{'} added their vote before\.{?}
}%
\@xx{}%
 \@x{\@s{52.01} \.{\land} \{ sj \.{\in} Range ( j . secretJudgments ) \.{:} sj
 . judge \.{=} judge \} \.{\neq} \{ \}}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
 Has \mbox{'}judge\mbox{'} showed their vote before\.{?}
}%
\@xx{}%
 \@x{\@s{52.01} \.{\land} \{ oj \.{\in} Range ( j . openJudgments ) \.{:} oj .
 judge \.{=} judge \} \.{=} \{ \}}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
 Secret and open votes should be the same
}%
\@xx{}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
 This validation is done with \ensuremath{HMAC} in practice
}%
\@xx{}%
\@x{\@s{52.01} \.{\land} \E\, sj \.{\in} Range ( j . secretJudgments ) \.{:}}%
\@x{\@s{67.22} \.{\land}\@s{4.1} sj . judge\@s{5.50} \.{=} judge}%
\@x{\@s{67.22} \.{\land}\@s{4.09} openVote \.{=} sj . vote}%
\@x{\@s{52.01}}%
\@y{\@s{0}%
 Update
}%
\@xx{}%
 \@x{\@s{52.01} \.{\land}\@s{4.1} public \.{'} \.{=} [ public {\EXCEPT}
 {\bang} . judgments [ index ] \.{=} [ @ {\EXCEPT}}%
\@x{\@s{116.10} {\bang} . openJudgments \.{=} Append ( @ ,\,}%
\@x{\@s{131.65} [\@s{8.2} judge \.{\mapsto} judge ,\,}%
\@x{\@s{142.62} vote \.{\mapsto} openVote ] ) ,\,}%
\@x{\@s{116.10} {\bang} . tally . for \.{=} {\IF} openVote \.{=}\@w{TRUE}}%
\@x{\@s{181.02} \.{\THEN} @ \.{+} 1}%
\@x{\@s{181.02} \.{\ELSE} @ ,\,}%
 \@x{\@s{116.10} {\bang} . tally . against \.{=} {\IF} openVote
 \.{=}\@w{FALSE}}%
\@x{\@s{177.89} \.{\THEN} @ \.{+} 1}%
\@x{\@s{177.89} \.{\ELSE} @ ] ]}%
\@pvspace{16.0pt}%
\@x{ CloseJudgment ( judgmentId ,\, owner ) \.{\defeq}}%
\@x{\@s{16.4} \.{\lor}\@s{4.1} Len ( public . judgments ) \.{=} 0}%
 \@x{\@s{16.4} \.{\lor}\@s{4.09} \E\, index \.{\in} {\DOMAIN} public .
 judgments \.{:}}%
\@x{\@s{42.93} \.{\LET} j \.{\defeq} public . judgments [ index ]}%
 \@x{\@s{63.33} finalResult \.{\defeq} ToString ( j . tally . for \.{>} j .
 tally . against ) \.{\IN}}%
\@x{\@s{63.33} \.{\land}\@s{4.1} j . id \.{=} judgmentId}%
\@x{\@s{63.33} \.{\land}\@s{4.09} j . status \.{=}\@w{active}}%
\@x{\@s{63.33} \.{\land}\@s{4.09} j . phase\@s{2.49} \.{=}\@w{openVotes}}%
\@x{\@s{63.33} \.{\land}\@s{4.09} j . owner \.{=} owner}%
 \@x{\@s{63.33} \.{\land} 2 \.{*} j . targetVotes \.{-} 1 \.{\leq} Len ( j .
 openJudgments )}%
\@x{\@s{78.54}}%
\@y{\@s{0}%
 We have a majority!
}%
\@xx{}%
 \@x{\@s{63.33} \.{\land}\@s{4.09} \.{\lor}\@s{4.1} \.{\land}\@s{4.1} j .
 tally . for \.{\neq} j . tally . against}%
\@x{\@s{93.75} \.{\land}\@s{4.09} public \.{'} \.{=} [ public {\EXCEPT}}%
\@x{\@s{125.36} {\bang} . judgments [ index ] \.{=}}%
\@x{\@s{140.91} [ @ {\EXCEPT}}%
\@x{\@s{155.56} {\bang} . status \.{=}\@w{closed} ,\,}%
\@x{\@s{155.56} {\bang} . phase \.{=}\@w{judgment} ,\,}%
\@x{\@s{155.56} {\bang} . finalResult \.{=} finalResult ] ,\,}%
\@x{\@s{125.36} {\bang} . nodes \.{=} Rewards ( j ) ]}%
\@x{\@s{78.54}}%
\@y{\@s{0}%
 Everyone has voted, and we don\mbox{'}t have a majority
}%
\@xx{}%
 \@x{\@s{78.54} \.{\lor}\@s{4.1} \.{\land}\@s{4.1} j . tally . for \.{=} j .
 tally . against}%
 \@x{\@s{93.75} \.{\land}\@s{4.09} public \.{'} \.{=} [ public {\EXCEPT}
 {\bang} . judgments [ index ] \.{=} [ @ {\EXCEPT}}%
\@x{\@s{157.84} {\bang} . status \.{=}\@w{closed} ,\,}%
\@x{\@s{157.84} {\bang} . finalResult \.{=}\@w{undecided} ] ]}%
\@pvspace{16.0pt}%
\@x{}%
\@y{\@s{0}%
 \ceqdash{8} Invariants \ceqdash{8}
}%
\@xx{}%
\@pvspace{8.0pt}%
\@x{ OwnOneJudgmentAtATime \.{\defeq}}%
\@x{\@s{16.4}}%
\@y{\@s{0}%
 For all active judgments \ensuremath{j}, \ensuremath{j2} where \ensuremath{j
 \.{\neq} j2}: \ensuremath{j.owner \.{\neq} j2.owner
}}%
\@xx{}%
\@x{\@s{16.4}}%
\@y{\@s{0}%
 Needed to ensure that judgments can be paid for.
}%
\@xx{}%
 \@x{\@s{16.4} \A\, j \.{\in} Range ( public . judgments ) \.{:} j . status
 \.{=}\@w{active} \.{\implies}}%
 \@x{\@s{27.72} ( \A\, j2 \.{\in} Range ( public . judgments ) \.{:} j2 .
 status \.{=}\@w{active} \.{\land}}%
 \@x{\@s{38.83} j . id \.{\neq} j2 . id \.{\implies} j . owner \.{\neq} j2 .
 owner )}%
\@pvspace{8.0pt}%
\@x{ LessActiveThenNodes \.{\defeq}}%
\@x{\@s{16.4}}%
\@y{\@s{0}%
 There should never be more active judgments than nodes
}%
\@xx{}%
 \@x{\@s{16.4} \.{\LET} active \.{\defeq} \{ j \.{\in} Range ( public .
 judgments ) \.{:} j . status \.{=}\@w{active} \}}%
\@x{\@s{16.4} \.{\IN} Cardinality ( active ) \.{\leq} Cardinality ( Nodes )}%
\@pvspace{16.0pt}%
\@x{ NoPackagesAreWronglyJudged \.{\defeq}}%
\@x{\@s{16.4} \A\, j \.{\in} Range ( public . judgments ) \.{:}}%
 \@x{\@s{27.72} \.{\lor}\@s{4.1} j . finalResult \.{=} ToString (
 IsReproducible ( j . id ) )}%
\@x{\@s{27.72} \.{\lor}\@s{4.09} j . finalResult \.{=}\@w{undecided}}%
\@pvspace{8.0pt}%
\@x{}%
\@y{\@s{0}%
 \ceqdash{8} \ensuremath{Spec} \ceqdash{8}
}%
\@xx{}%
\@pvspace{8.0pt}%
\@x{ Init \.{\defeq}}%
\@x{\@s{16.4} \.{\land} InitialPublic}%
\@x{\@s{16.4} \.{\land} InitialPrivate}%
\@x{\@s{16.4} \.{\land} nextPackageId \.{=} 9}%
\@pvspace{8.0pt}%
\@x{ Next \.{\defeq}}%
\@pvspace{8.0pt}%
\@x{\@s{33.24}}%
\@y{\@s{0}%
 Initializing a package judgment
}%
\@xx{}%
\@x{\@s{33.24} \.{\lor}\@s{4.1} \E\, n \.{\in} Nodes \.{:}}%
 \@x{\@s{48.45} \E\, index \.{\in} {\DOMAIN} private [ n ] . preferences
 \.{:}}%
 \@x{\@s{59.77} \.{\LET} p \.{\defeq} private [ n ] . preferences [ index ]
 \.{\IN}}%
\@x{\@s{80.17} \.{\land} RunSimulation}%
\@x{\@s{80.17} \.{\land} p . status \.{=}\@w{not{-}processed}}%
 \@x{\@s{80.17} \.{\land} InitializeJudgment ( p . package ,\, n ,\, p . level
 )}%
\@x{\@s{80.17} \.{\land} private \.{'} \.{=}}%
 \@x{\@s{95.38} [ private {\EXCEPT} {\bang} [ n ] . preferences [ index ] .
 status \.{=}\@w{started} ]}%
\@x{\@s{80.17} \.{\land} {\UNCHANGED} {\langle} nextPackageId {\rangle}}%
\@pvspace{8.0pt}%
\@x{\@s{33.24}}%
\@y{\@s{0}%
 Adding a secret vote
}%
\@xx{}%
\@x{\@s{33.24} \.{\lor}\@s{4.1} \E\, n \.{\in} Nodes \.{:}}%
\@x{\@s{48.45} \E\, j\@s{1.87} \.{\in} Range ( public . judgments ) \.{:}}%
\@x{\@s{59.77} \.{\LET} secretVote \.{\defeq} {\IF} n \.{\in} MaliciousNodes}%
\@x{\@s{152.12} \.{\THEN} {\lnot} IsReproducible ( j . package )}%
\@x{\@s{152.12} \.{\ELSE} IsReproducible ( j . package )}%
\@x{\@s{59.77} \.{\IN}}%
\@x{\@s{76.17} \.{\land} RunSimulation}%
\@x{\@s{76.17}}%
\@y{\@s{0}%
 Nodes only build/judge if they have to
}%
\@xx{}%
 \@x{\@s{76.17} \.{\land}\@s{4.1} \.{\lor}\@s{4.1} FutureCost ( n ) \.{>}
 public . nodes [ n ] . wallet \.{-} 1}%
\@x{\@s{91.38} \.{\lor}\@s{4.09} j . owner \.{=} n}%
\@x{\@s{91.38} \.{\lor}\@s{4.09} j . package \.{\in} PreferredPackages ( n )}%
 \@x{\@s{76.17} \.{\land}\@s{4.09} AddSecretJudgment ( j . id ,\, n ,\,
 ToString ( secretVote ) )}%
 \@x{\@s{76.17} \.{\land}\@s{4.09} {\UNCHANGED} {\langle} private ,\,
 nextPackageId {\rangle}}%
\@pvspace{8.0pt}%
\@x{\@s{33.24}}%
\@y{\@s{0}%
 End submission of secret votes
}%
\@xx{}%
\@x{\@s{33.24} \.{\lor}\@s{4.1} \E\, n \.{\in} Nodes \.{:}}%
\@x{\@s{48.45} \E\, j\@s{1.87} \.{\in} Range ( public . judgments ) \.{:}}%
\@x{\@s{59.77} \.{\land} RunSimulation}%
\@x{\@s{59.77}}%
\@y{\@s{0}%
 Assume that every node that *needs* to vote will have the time to do so
}%
\@xx{}%
 \@x{\@s{59.77} \.{\land}\@s{4.1} \A\, nonVoter \.{\in} Nodes
 \.{\,\backslash\,} SecretJudges ( j ) \.{:}}%
\@x{\@s{86.30} \.{\lor}\@s{4.1} IsFinanciallyIncentivizedToVote ( nonVoter )}%
\@x{\@s{86.30} \.{\lor}\@s{4.09} n \.{\in} MaliciousNodes}%
\@x{\@s{59.77} \.{\land}\@s{4.09} EndSecretSubmissions ( j . id ,\, n )}%
 \@x{\@s{59.77} \.{\land} {\UNCHANGED} {\langle} private ,\, nextPackageId
 {\rangle}}%
\@pvspace{8.0pt}%
\@x{\@s{33.24}}%
\@y{\@s{0}%
 Add an open vote
}%
\@xx{}%
\@x{\@s{33.24} \.{\lor}\@s{4.1} \E\, n \.{\in} Nodes \.{:}}%
\@x{\@s{48.45} \E\, j\@s{1.87} \.{\in} Range ( public . judgments ) \.{:}}%
\@x{\@s{59.77} \.{\LET} openVote \.{\defeq} {\IF} n \.{\in} MaliciousNodes}%
\@x{\@s{155.70} \.{\THEN} {\lnot} IsReproducible ( j . package )}%
\@x{\@s{155.70} \.{\ELSE} IsReproducible ( j . package )}%
\@x{\@s{59.77} \.{\IN}}%
\@x{\@s{76.17} \.{\land} RunSimulation}%
 \@x{\@s{76.17} \.{\land}\@s{4.1} \.{\lor}\@s{4.1} FutureCost ( n ) \.{>}
 public . nodes [ n ] . wallet \.{-} 1}%
\@x{\@s{91.38} \.{\lor}\@s{4.09} j . owner \.{=} n}%
\@x{\@s{91.38} \.{\lor}\@s{4.09} j . package \.{\in} PreferredPackages ( n )}%
 \@x{\@s{76.17} \.{\land} ShowJudgment ( j . id ,\, n ,\, ToString ( openVote
 ) )}%
 \@x{\@s{76.17} \.{\land} {\UNCHANGED} {\langle} private ,\, nextPackageId
 {\rangle}}%
\@pvspace{8.0pt}%
\@x{\@s{33.24}}%
\@y{\@s{0}%
 Close judgment
}%
\@xx{}%
\@x{\@s{33.24} \.{\lor}\@s{4.1} \E\, n \.{\in} Nodes \.{:}}%
\@x{\@s{48.45} \E\, j\@s{1.87} \.{\in} Range ( public . judgments ) \.{:}}%
\@x{\@s{59.77} \.{\land} RunSimulation}%
\@x{\@s{59.77}}%
\@y{\@s{0}%
 Assume that every node that *needs* to vote will have the time to do so
}%
\@xx{}%
 \@x{\@s{59.77} \.{\land}\@s{4.1} \A\, nonVoter \.{\in} Nodes
 \.{\,\backslash\,} OpenJudges ( j ) \.{:}}%
\@x{\@s{86.30} \.{\lor} IsFinanciallyIncentivizedToVote ( nonVoter )}%
\@x{\@s{86.30} \.{\lor} n \.{\in} MaliciousNodes}%
\@x{\@s{59.77} \.{\land}\@s{4.09} CloseJudgment ( j . id ,\, n )}%
\@x{\@s{59.77}}%
\@y{\@s{0}%
 Update the nodes preferences
}%
\@xx{}%
 \@x{\@s{59.77} \.{\land}\@s{4.1} \E\, preferenceIndex \.{\in} {\DOMAIN}
 private [ n ] . preferences \.{:}}%
 \@x{\@s{86.30} \.{\land} private [ n ] . preferences [ preferenceIndex ] .
 package}%
\@x{\@s{117.92} \.{=} j . package}%
\@x{\@s{86.30} \.{\land} private \.{'} \.{=}}%
 \@x{\@s{97.42} [ private {\EXCEPT} {\bang} [ n ] . preferences [
 preferenceIndex ] . status}%
\@x{\@s{116.59} \.{=}\@w{processed} ]}%
 \@x{\@s{59.77} \.{\land} {\UNCHANGED}\@s{4.1} {\langle} nextPackageId
 {\rangle}}%
\@pvspace{8.0pt}%
\@x{\@s{33.24}}%
\@y{\@s{0}%
 Add additional package to node
}%
\@xx{}%
\@x{\@s{33.24} \.{\lor}\@s{4.1} \E\, n \.{\in} Nodes \.{:}}%
\@x{\@s{48.45} \.{\land} RunSimulation}%
\@x{\@s{48.45} \.{\land} AddPreferencedPackage ( n )}%
\@x{\@s{48.45} \.{\land} {\UNCHANGED} {\langle} public {\rangle}}%
\@pvspace{8.0pt}%
\@x{\@s{33.24}}%
\@y{\@s{0}%
 End simulation
}%
\@xx{}%
\@x{\@s{33.24} \.{\lor}\@s{4.1} \.{\land} {\lnot} RunSimulation}%
 \@x{\@s{48.45} \.{\land} {\UNCHANGED} {\langle} private ,\, public ,\,
 nextPackageId {\rangle}}%
\@pvspace{16.0pt}%
 \@x{ Spec\@s{1.46} \.{\defeq} Init \.{\land} {\Box} [ Next ]_{ {\langle}
 public ,\, private ,\, nextPackageId {\rangle}}}%
\@pvspace{16.0pt}%
\@x{}\bottombar\@xx{}%
\end{document}
